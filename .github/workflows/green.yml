name: Green Contributions

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/green.yml"
      - "data/heartbeat.txt"
  schedule:
    # Run 3 times daily: morning, afternoon, night (UTC times)
    - cron: "0 6 * * *"   # 6:00 UTC (morning)
    - cron: "0 12 * * *"  # 12:00 UTC (afternoon)
    - cron: "0 18 * * *"  # 18:00 UTC (night)

permissions:
  contents: write

jobs:
  green:
    runs-on: ubuntu-latest
    env:
      COMMIT_AUTHOR_NAME: ${{ secrets.COMMIT_AUTHOR_NAME }}
      COMMIT_AUTHOR_EMAIL: ${{ secrets.COMMIT_AUTHOR_EMAIL }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          ref: main
      - name: Resolve author (auto)
        run: |
          ACTOR="${{ github.actor }}"
          ID=$(curl -s https://api.github.com/users/$ACTOR | grep -m1 '\"id\"' | sed -E 's/.*\"id\": ([0-9]+).*/\1/')
          echo "COMMIT_AUTHOR_NAME=${ACTOR}" >> $GITHUB_ENV
          echo "COMMIT_AUTHOR_EMAIL=${ID}+${ACTOR}@users.noreply.github.com" >> $GITHUB_ENV
      - name: Prepare branch
        run: |
          git config user.name "${COMMIT_AUTHOR_NAME:-github-actions[bot]}"
          git config user.email "${COMMIT_AUTHOR_EMAIL:-github-actions[bot]@users.noreply.github.com}"
          git pull --rebase origin main || true
      - name: Create 5 commits per run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p data
          # Create 5 commits with unique timestamps per run
          # Total: 3 runs * 5 commits = 15 commits daily
          for i in $(seq 1 5); do
            date -u +"%Y-%m-%dT%H:%M:%SZ" >> data/heartbeat.txt
            git add data/heartbeat.txt
            git commit -m "heartbeat $i: $(date +'%H:%M %Z')"
          done
          # Push all commits at once with retry logic
          for attempt in 1 2 3; do
            git push && break || (
              echo "Push failed, attempt $attempt/3"
              git pull --rebase origin main || true
              sleep 2
            )
          done
      
      # Balance contribution graph with equal activities across all categories
      - name: Create and close issues (morning/afternoon)
        if: github.event.schedule == '0 6 * * *' || github.event.schedule == '0 12 * * *'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # Create 2 issues per run (total 4 daily)
          for i in 1 2; do
            ISSUE_TITLE="Activity check ${i}: $(date +'%Y-%m-%d %H:%M UTC')"
            ISSUE_BODY="Automated issue to balance contribution graph. Run: $(date +'%H:%M UTC')"
            ISSUE_NUMBER=$(curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$REPO/issues \
              -d "{\"title\":\"$ISSUE_TITLE\",\"body\":\"$ISSUE_BODY\"}" \
              | jq -r .number)
            echo "Created issue #$ISSUE_NUMBER"
            
            # Close issue
            curl -s -X PATCH -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$REPO/issues/$ISSUE_NUMBER \
              -d '{"state":"closed"}'
            echo "Closed issue #$ISSUE_NUMBER"
            
            # Small delay to prevent API rate limiting
            sleep 1
          done
      
      - name: Create and merge pull requests (morning/afternoon)
        if: github.event.schedule == '0 6 * * *' || github.event.schedule == '0 12 * * *'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # Create 2 PRs per run (total 4 daily)
          for i in 1 2; do
            BRANCH_NAME="daily-pr-${i}-$(date +'%Y%m%d-%H%M')"
            
            # Create feature branch
            git checkout -b $BRANCH_NAME
            
            # Make unique change
            echo "PR Update ${i}: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> pr-updates.md
            git add pr-updates.md
            git commit -m "PR ${i}: Daily update $(date +'%Y-%m-%d %H:%M UTC')"
            git push -u origin $BRANCH_NAME
            
            # Create pull request
            PR_TITLE="PR ${i}: Daily update $(date +'%Y-%m-%d %H:%M UTC')"
            PR_BODY="Automated PR to balance contribution graph. Branch: $BRANCH_NAME"
            PR_NUMBER=$(curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$REPO/pulls \
              -d "{\"title\":\"$PR_TITLE\",\"body\":\"$PR_BODY\",\"head\":\"$BRANCH_NAME\",\"base\":\"main\"}" \
              | jq -r .number)
            echo "Created PR #$PR_NUMBER"
            
            # Add approval review (counts as code review)
            curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/reviews \
              -d '{"event":"APPROVE","body":"Approved automated PR."}'
            echo "Approved PR #$PR_NUMBER"
            
            # Merge pull request
            curl -s -X PUT -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/merge \
              -d '{"merge_method":"squash"}'
            echo "Merged PR #$PR_NUMBER"
            
            # Delete branch
            curl -s -X DELETE -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$REPO/git/refs/heads/$BRANCH_NAME
            echo "Deleted branch $BRANCH_NAME"
            
            # Clean up locally and prepare for next PR
            git checkout main
            git branch -D $BRANCH_NAME 2>/dev/null || true
            
            # Small delay to prevent API rate limiting
            sleep 2
          done
